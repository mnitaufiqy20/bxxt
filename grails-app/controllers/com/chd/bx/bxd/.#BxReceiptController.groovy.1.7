package com.chd.bx.bxd

import java.text.SimpleDateFormat

/**
 *   用户登录service
 *   @author 孟敏
 *   @time 2013年1月6日
 */
class BxReceiptController {
    static allowedMethods = [save: "POST", update: "POST", delete: "POST"]
    static bxReceipt   = new BxReceipt();
    static bxReceiptService = new BxReceiptService()
    static bxOther = new BxOther();
//    static bxOtherService = new BxOtherService();
    def index() {
        List<BxReceipt> bxdList = new ArrayList<BxReceipt>()
        bxdList = bxReceiptService.bxdQueryAll()
        render(view: '../bxReceipt/bxReceiptQuery',model: [bxdList:bxdList])
    }
    def bxdDetail(){
        bxReceipt = new BxReceipt();
        bxReceipt.bxNo="保存后自动生成"
        bxReceipt.approvalTime=sysDateFormat()
        List<BxOther> listOther = new ArrayList<BxOther>()
//        listOther=bxOtherService.otherQueryByBxdNo("J0011301002")
        List<BxLoan>  listLoan = new ArrayList<BxLoan>();
        List<BxTravel> listCl = new ArrayList<BxTravel>();
        List<BxZhaoDai> listZd = new ArrayList<BxZhaoDai>();
        List<BxWork> listBg = new ArrayList<BxWork>();
        BxTravel bxTravel = new BxTravel();
        render(view: '../bxReceipt/bxReceiptDetail',model: [bxReceipt:bxReceipt,bxTravel:bxTravel,listOther:listOther,listLoan:listLoan,listCl:listCl,listZd:listZd,listBg:listBg])
//        List<BxOther> listOther = new ArrayList<BxOther>()
//        listOther=bxOtherService.otherQueryByBxdNo("J0011301002")
//
//        render(view: '/bxReceipt/test',model: [listOther:listOther])
    }
    def bxdUpdate(params){
        bxReceipt = getBxdById(params);
        render(view: '../bxReceipt/bxReceiptDetail',model: [bxReceipt:bxReceipt])
    }
    static getBxdById(params){
        List<BxReceipt> list = new ArrayList<BxReceipt>()
        list=bxReceiptService.getBxdById(params["bxNo"])
        bxReceipt = new BxReceipt()
        if(list!=null && list.size()>0){
            bxReceipt = list.get(0)
        }
    }
    /**
     * 添加保存
     */
    def bxdSave(params){

        bxReceipt.bxdStatus="已保存"
        bxReceipt=bxRep(bxReceipt,params)
        if (bxReceipt.bxNo=="保存后自动生成"){
            def bxdNo=getBxdNo()
            bxReceipt.setBxNo(bxdNo)
        }
        bxReceiptService.bxdSave(bxReceipt)
        render(view: '/bxReceipt/bxReceiptDetail',model: [bxReceipt:bxReceipt])
    }

    //在新增时获得单号
    static getBxdNo(){
        String bxdNo = "J";
        def comNo = "0001"  //公司代码（四位）

        //年月 （四位）
        Date date = new Date()
        SimpleDateFormat matter=new SimpleDateFormat("yyyyMM")
        String dates = matter.format(date);
        println("dates:"+dates)
        def comAndDate = comNo + dates.substring(2,6)
        bxdNo += comAndDate

        //流水号（三位）
        def serialNumberList = new ArrayList<String>()
        List<BxReceipt> loan_list = bxReceiptService.bxdQueryAll()
        def n1 = 0
        def n2 = 0
        if(loan_list!=null&&loan_list.size()>0){
            for (int i=0;i<loan_list.size();i++){
                def str = loan_list.get(i).getBxNo()
                def s = str.substring(1,9)
                if (comAndDate.equals(s)){
                    if (serialNumberList.size()==0){
                        n1 = Integer.parseInt(str.substring(9,str.length()))
                        serialNumberList.add(str.substring(9,str.length()))
                    }else{
                        n2 = Integer.parseInt(str.substring(9,str.length()))
                        if (n2 > n1){
                            serialNumberList.clear()
                            serialNumberList.add(str.substring(9,str.length()))
                            n1 = n2
                        }
                    }
                }
            }
        }

        if (serialNumberList.size()==0){
            bxdNo += "001"
        }else{
            int t =  Integer.parseInt(serialNumberList.get(0))+1
            int a = t/10
            def serialNumber = ""
            if (t<100){
                if (a>0){
                    serialNumber = "0"+t
                }else{
                    serialNumber = "00"+t
                }
                bxdNo += serialNumber
            }else{
                bxdNo += t
            }
        }
        return bxdNo
    }
    /**
     * 赋值给对象
     */
    def bxRep(BxReceipt bxd,params){
        String bxEmpId=params['bxEmpNo']
        bxd.bxEmpNo = Integer.parseInt(bxEmpId)
        bxd.costCenter = params['costCenter']
        bxd.companyName = params['companyName']
        bxd.bxEmpName = params['bxEmpName']
        bxd.bxEmpPhoneNumber = params['bxEmpPhoneNumber']
        bxd.bxEmpPosition = params['bxEmpPosition']
        bxd.budgetCenter = params['budgetCenter']
        bxd.needMoneyDate =params['needMoneyDate']
        bxd.paymentMode = params['paymentMode']
        bxd.applicationDate = params['applicationDate']
        bxd.managerName = params['managerName']
        bxd.billsCurr = params['billsCurr']

        bxd.clTravelDetails = params['clTravelDetails']
        bxd.clTravelDays = Integer.parseInt(params['clTravelDays'])
        bxd.clStartDate = params['clStartDate']
        bxd.clEndDate = params['clEndDate']
        bxd.clSeAddress = params['clSeAddress']
        bxd.clExpenseType = params['clExpenseType']
        bxd.clTransport = params['clTransport']
        bxd.clOriginalSum = Double.parseDouble(params['clOriginalSum'])
        bxd.clBxRmbSum = Double.parseDouble(params['clBxRmbSum'])
        bxd.clRemark = params['clRemark']

        bxd.zdDate = params['zdDate']
        bxd.zdExpenseType = params['zdExpenseType']
        bxd.zdOriginalSum = Double.parseDouble(params['zdOriginalSum'] )
        bxd.zdBxRmbSum =Double.parseDouble( params['zdBxRmbSum'])
        bxd.zdBillsExplain = params['zdBillsExplain']
        bxd.zdRemark = params['zdRemark']

        bxd.bgDate = params['bgDate']
        bxd.bgExpenseType = params['bgExpenseType']
        bxd.bgOriginalSum = Double.parseDouble(params['bgOriginalSum'] )
        bxd.bgBxRmbSum = Double.parseDouble(params['bgBxRmbSum']     )
        bxd.bgBillsExplain = params['bgBillsExplain']
        bxd.bgRemark = params['bgRemark']

//        bxd.otherDate = params['otherDate']
//        bxd.otherOriginalSum =Double.parseDouble( params['otherOriginalSum']   )
//        bxd.otherBxRmbSum =Double.parseDouble( params['otherBxRmbSum']    )
//        bxd.otherBillsExplain = params['otherBillsExplain']
//        bxd.otherRemark = params['otherRemark']

        bxd.bxCostCounts =Double.parseDouble( params['bxCostCounts']   )

        bxd.loanDate =params['loanDate']
        bxd.loanNo = params['loanNo']
        bxd.loanBillsCurr = params['loanBillsCurr']
        bxd.loanOriginalSum =Double.parseDouble( params['loanOriginalSum'] )
        bxd.loanBalance =Double.parseDouble( params['loanBalance']   )
        bxd.loanTheRepayment =Double.parseDouble( params['loanTheRepayment'] )
        bxd.loanRemark = params['loanRemark']

        bxd.payCounts = Double.parseDouble(params['payCounts'] )
        bxd.billsCounts = Integer.parseInt(params['billsCounts'] )
        bxd.expenseCategory = params['expenseCategory']
        bxd.budgetYear = Integer.parseInt(params['budgetYear']  )
        bxd.budgetMonth = Integer.parseInt(params['budgetMonth']  )
        bxd.budgetQuarter = Integer.parseInt(params['budgetQuarter'] )
        bxd.balanceBudgetYear =Double.parseDouble( params['balanceBudgetYear']        )
        bxd.balanceBudgetMonth = Double.parseDouble(params['balanceBudgetMonth']     )
        bxd.balanceBudgetQuarter =Double.parseDouble( params['balanceBudgetQuarter'])
        bxd.budgetYearPro = Double.parseDouble(params['budgetYearPro']        )
        bxd.budgetMonthPro =Double.parseDouble( params['budgetMonthPro']     )
        bxd.budgetQuarterPro = Double.parseDouble(params['budgetQuarterPro'])
        bxd.approvalTime = params['approvalTime']
        bxd.approvalOpinions = params['approvalOpinions']
        bxd.approverPosition = params['approverPosition']
        bxd.approver = params['approver']
        bxd.approvalStatus = params['approvalStatus']
        return  bxd;
    }
    def sysDateFormat(){
        Date date = new Date();
        SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");
        String sysDate = sdf.format(date);
        return  sysDate;
    }

}
